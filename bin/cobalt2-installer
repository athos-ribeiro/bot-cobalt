#!perl

my $VERSION = 2;

use v5.10;
use strictures 1;

use Scalar::Util       'blessed', 'reftype';
use Path::Tiny         'path';
use File::ShareDir     'dist_dir';
use Bot::Cobalt::Utils 'rplprintf', 'mkpasswd';
use Bot::Cobalt::Frontend::Utils ':all';
use Bot::Cobalt::Frontend::RC    'rc_read', 'rc_write';


my $rcfile = path(
  $ENV{HOME} ? $ENV{HOME} . '/.cobalt2rc' : '.cobalt2rc'
);

use Getopt::Long;
GetOptions(
  'config|rcfile=s' => \$rcfile,

  version => sub {
    say "Bot::Cobalt installer (version $VERSION)";
    exit 0
  },

  help    => sub {
    print map "$_\n",
      "  --config / --rcfile=PATH",
      "    [default: $rcfile]"
    ;
    exit 0
  },
);


sub read_format_write {
  my ($path, $vars) = @_;
  die "Expected Path::Tiny but got $path"
    unless blessed $path && $path->isa('Path::Tiny');
  die "Expected HASH of template var replacements but got $vars"
    unless reftype $vars eq 'HASH';

  my $in = $path->slurp_utf8;
  my $out = rplprintf($in, $vars);
  $path->spew_utf8($out);
  $path
}



sub build_dir_skeleton {
  my ($base, $etc, $var) = @_;
  die "Expected a base Path object but got $path"
    unless blessed $path && $path->isa('Path::Tiny');

  $etc = path( $base . '/etc' ) unless $etc;
  $var = path( $base . '/var' ) unless $var;
  my $dbpath = path( $var . '/db' );
  $_->mkpath for $etc, $var, $dbpath;

  wantarray ? ($base, $etc, $var) : $base
}


sub copy_base_confs {
  # FIXME copy from sharedir
}


sub non_interactive {
  # FIXME set up some default var replacements
}


sub interactive {
  # FIXME prompt for var replacements
}


## FIXME
##   should be able to install non-interactively (template replacement
##   defaults)
##
##   interactive mode needs to cover:
##    - rcfile placement
##      * default to $rcfile
##      * prompt if overwriting
##    - cobalt basedir
##      * default to $HOME/cobalt2
##      * prompt if exists and populated
##    - cobalt.conf
##      * CFG_BOT_NICK, CFG_BOT_USERNAME, CFG_BOT_REALNAME
##      * CFG_CMD_CHAR
##      * CFG_SERVER_ADDR
##      * CFG_USE_SSL
##      * CFG_SERVER_PORT
##    - channels.conf
##      * CHAN
##      * ??
##    - auth.conf
##      * AUTH_USER
##      * AUTH_PASS  (Termios turn off echo)
##      * AUTH_MASK
##      * ability to add more users?
##
##   installation should populate:
##    - $rcfile
##    - $basedir/etc/ by copying from ShareDir
##    - template replacement for:
##      * cobalt.conf
##      * channels.conf
##      * auth.conf
##      * write as we go?
##    - $basedir/var/db [empty]

