#!/usr/bin/env perl
use strict;
use warnings;

use App::Pod2CpanHtml;

use Time::Piece;

## where to grab POD from:
my $pod_root = "../../";

my $outdir = "../../doc/html";
my $index = $outdir."/index.html";

my $files = {

  Manuals => {

    "doc/Writing_Plugins.pod" => {
      name => "Writing_Plugins.html",
      desc => "<b>The Cobalt Plugin Author's Manual</b>",
    },

  },

  Modules => {

    "lib/Cobalt.pm" => {
      name => "Cobalt.html",
      desc => "<b>Cobalt core</b>",
    },

    "lib/Cobalt/IRC.pm" => {
     name => "Cobalt-IRC.html",
      desc => "<b>Core single-server IRC interface</b>",
    },

    "lib/Cobalt/Utils.pm" => {
      name => "Cobalt-Utils.html",
      desc => "<b>Utils for Cobalt plugins</b>",
    },

    "lib/Cobalt/Lang.pm" => {
      name => "Cobalt-Lang.html",
      desc => "<b>Cobalt language set handler</b>",
    },

  },

};

my $host = `hostname`;

for my $cat ("Manuals", "Modules")
{
  for my $in (sort keys %{ $files->{$cat} }) {
    my $in_file = $pod_root ."/". $in ;
    my $out = $outdir ."/". $files->{$cat}->{$in}->{name};
    if ( $in ) {
      open IN, $in_file or (print "Couldn't open $in: $!\n" && next);
    }
    if ( $out ) {
      open OUT, '>', $out or (print "Couldn't open $out: $!\n" && next);
    }
    my $parser = App::Pod2CpanHtml->new();
    $parser->index(1);
    $parser->output_fh(*OUT);
    $parser->html_header_after_title('</title>
			<link rel="stylesheet" type="text/css" title="pod_stylesheet" href="http://search.cpan.org/s/style.css">
			<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
			<h1>Cobalt2 POD ('.$in.')</h1>
			</head>
			<body class="pod">
                                 ');
    $parser->parse_file(*IN);
    close(IN);
    close(OUT);
  }
}

open(my $indx,'>',$index) or print "Couldn't open $index: $!\n";

my $pod;
for my $cat ("Manuals", "Modules")
{
  $pod .= "<h3>$cat</h3><ul>";
  for my $fi (sort keys %{ $files->{$cat} }) {
    (my $linked = $files->{$cat}->{$fi}->{name}) =~ s/\.html//;
    my $desc = $files->{$cat}->{$fi}->{desc};
    $pod .= "<li><b><a href='$linked.html'>$linked</a></b> &rarr; $desc<br/>";
  }
  $pod .= "</ul>";
}

my $html = <<'EOF';
 <html>
 <head>
 <title>Cobalt2 developer docs</title>
 <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1" >
 <link rel="stylesheet" type="text/css" title="pod_stylesheet" href="http://search.cpan.org/s/style.css">
 </head>
 <body class="pod">
 <h1>Cobalt2 technical/API documentation</h1>
 
 <h2>POD (converted)</h2>
EOF

$html .= $pod;
$html .= <<'EOF';
 </ul>

 <hr/>
 <p>contact: <a href="mailto:irc@cobaltirc.org">irc@cobaltirc.org</a></p>
EOF
my $t = localtime;
my $d = $t->ymd() .' '. $t->hms();
$html .= "<p><i style='color:484848;'>index last generated by <b>htmlify_docs</b> 
           on <span style='color:teal'>$host</span> at $d</i></p>";
$html .= <<'EOF';
 </body>
 </html>
EOF

print $indx $html;
close($indx);
